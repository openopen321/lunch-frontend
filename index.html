<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¾¦å…¬å®¤è¨‚ä¾¿ç•¶ç³»çµ±</title>
    <!-- å¼•å…¥ React å’Œ Tailwind CSS -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f3f4f6; }
        .mobile-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // è¨­å®šå€ï¼šä½ çš„å¾Œç«¯ç¶²å€ (æˆ‘å·²ç¶“å¹«ä½ å¡«å¥½äº†)
        // ==========================================
        const API_BASE_URL = "https://lunch-backend-iccv.onrender.com"; 

        const { useState, useEffect } = React;

        // é è¨­é¤å»³è³‡æ–™ (å¦‚æœå¾Œç«¯é‚„æ²’å›æ‡‰æ™‚é¡¯ç¤º)
        const DEFAULT_RESTAURANT = {
            name: "è¼‰å…¥ä¸­...",
            address: "è«‹ç¨å€™",
            phone: "",
            minDelivery: 0,
            menu: []
        };

        function App() {
            // é é¢ç‹€æ…‹: landing(é¦–é ), create(é–‹åœ˜), order(é»é¤), admin(ç®¡ç†)
            const [view, setView] = useState('landing');
            const [loading, setLoading] = useState(false);
            const [groupId, setGroupId] = useState(null);
            const [groupData, setGroupData] = useState(null); // { restaurant, orders, status }
            
            // è³¼ç‰©è»Šèˆ‡ä½¿ç”¨è€…
            const [cart, setCart] = useState({});
            const [myName, setMyName] = useState("");
            const [orderNote, setOrderNote] = useState("");
            const [isNameModalOpen, setIsNameModalOpen] = useState(false);

            // åˆå§‹åŒ–ï¼šè®€å–ç¶²å€åƒæ•¸ (çœ‹çœ‹æ˜¯ä¸æ˜¯åˆ¥äººå‚³ä¾†çš„é€£çµ)
            useEffect(() => {
                const savedName = localStorage.getItem('userName');
                if (savedName) setMyName(savedName);

                // æª¢æŸ¥ç¶²å€æœ‰æ²’æœ‰ ?group_id=xxx
                const params = new URLSearchParams(window.location.search);
                const urlGroupId = params.get('group_id');
                const urlView = params.get('view');

                if (urlGroupId) {
                    setGroupId(urlGroupId);
                    fetchGroupData(urlGroupId);
                    if (urlView === 'order') setView('order');
                    else if (urlView === 'admin') setView('admin');
                    else setView('order'); // é è¨­é€²å…¥é»é¤
                }
            }, []);

            // å®šæ™‚æ›´æ–°è³‡æ–™ (ç°¡æ˜“ç‰ˆå³æ™‚åŒæ­¥)
            useEffect(() => {
                if (!groupId) return;
                const interval = setInterval(() => {
                    fetchGroupData(groupId);
                }, 5000); // æ¯5ç§’æ›´æ–°ä¸€æ¬¡
                return () => clearInterval(interval);
            }, [groupId]);

            // ---------------- API ä¸²æ¥ ----------------

            const fetchGroupData = async (id) => {
                try {
                    const res = await fetch(`${API_BASE_URL}/api/group/${id}`);
                    if (res.ok) {
                        const data = await res.json();
                        setGroupData(data);
                    }
                } catch (err) {
                    console.error("æ›´æ–°å¤±æ•—", err);
                }
            };

            const handleCreateGroup = async (url) => {
                setLoading(true);
                try {
                    // 1. åˆ†æèœå–®
                    const analyzeRes = await fetch(`${API_BASE_URL}/api/analyze_menu`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ url })
                    });
                    const restaurantData = await analyzeRes.json();

                    // 2. å»ºç«‹åœ˜è³¼
                    const createRes = await fetch(`${API_BASE_URL}/api/create_group`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ restaurant: restaurantData })
                    });
                    const { group_id } = await createRes.json();

                    // 3. å®Œæˆ
                    setGroupId(group_id);
                    setGroupData({ restaurant: restaurantData, orders: [], status: 'OPEN' });
                    
                    // æ›´æ–°ç¶²å€ä½†ä¸é‡æ–°æ•´ç†
                    window.history.pushState({}, '', `?group_id=${group_id}&view=admin`);
                    setView('admin');
                } catch (err) {
                    alert("é–‹åœ˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¾Œç«¯æ˜¯å¦æ­£å¸¸é‹ä½œã€‚\n" + err);
                } finally {
                    setLoading(false);
                }
            };

            const handleSubmitOrder = async () => {
                if (!groupId) return;
                const newItems = [];
                const menu = groupData.restaurant.menu;
                
                Object.keys(cart).forEach(itemId => {
                    const item = menu.find(m => m.id === parseInt(itemId));
                    if (item) newItems.push({ ...item, qty: cart[itemId] });
                });

                const orderPayload = {
                    id: Date.now(),
                    user: myName,
                    items: newItems,
                    paidAmount: 0,
                    status: 'unpaid',
                    note: orderNote
                };

                try {
                    await fetch(`${API_BASE_URL}/api/group/${groupId}/order`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(orderPayload)
                    });
                    alert(`è¨‚å–®å·²é€å‡ºï¼\nè¨‚è³¼äººï¼š${myName}`);
                    setCart({});
                    setOrderNote("");
                    fetchGroupData(groupId); // é¦¬ä¸Šæ›´æ–°
                } catch (err) {
                    alert("é€å‡ºå¤±æ•—");
                }
            };

            const handleStatusChange = async (newStatus) => {
                try {
                    await fetch(`${API_BASE_URL}/api/group/${groupId}/status`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ status: newStatus })
                    });
                    // æ‰‹å‹•æ›´æ–°æœ¬åœ°ç‹€æ…‹ä»¥æ±‚å³æ™‚åæ‡‰
                    setGroupData(prev => ({ ...prev, status: newStatus }));
                } catch (err) {
                    alert("æ›´æ–°ç‹€æ…‹å¤±æ•—");
                }
            };

            // ---------------- é‚è¼¯å°å·¥å…· ----------------

            const addToCart = (id) => setCart(prev => ({ ...prev, [id]: (prev[id] || 0) + 1 }));
            const removeFromCart = (id) => setCart(prev => {
                const newState = { ...prev };
                if (newState[id] > 1) newState[id]--;
                else delete newState[id];
                return newState;
            });

            const submitName = (name) => {
                if (!name.trim()) return;
                setMyName(name);
                localStorage.setItem('userName', name);
                setIsNameModalOpen(false);
                handleSubmitOrder();
            };

            const copyLink = () => {
                // ç”¢ç”Ÿä¹¾æ·¨çš„é€£çµ (é è¨­é€²å…¥ order é é¢)
                const url = `${window.location.origin}${window.location.pathname}?group_id=${groupId}&view=order`;
                navigator.clipboard.writeText(url).then(() => alert("âœ… ç¶²å€å·²è¤‡è£½ï¼\nè«‹è²¼åˆ° LINE ç¾¤çµ„çµ¦åŒäº‹ã€‚"));
            };

            const copyText = (text) => {
                navigator.clipboard.writeText(text).then(() => alert("âœ… æ–‡å­—å·²è¤‡è£½ï¼"));
            };

            // ---------------- ç•«é¢æ¸²æŸ“ ----------------

            // 1. é¦–é 
            if (view === 'landing') {
                return (
                    <div className="mobile-container">
                        <div className="bg-orange-500 text-white p-4 sticky top-0 z-50 shadow-md flex justify-between">
                            <h1 className="font-bold text-lg">ğŸ± è¾¦å…¬å®¤è¨‚ä¾¿ç•¶</h1>
                        </div>
                        <div className="p-6 flex flex-col items-center justify-center flex-1">
                            <div className="text-6xl mb-4">ğŸ±</div>
                            <h2 className="text-2xl font-bold text-gray-800 mb-2">ä»Šå¤©åƒä»€éº¼ï¼Ÿ</h2>
                            <p className="text-gray-500 text-center mb-8">è²¼ä¸Š Google Mapsï¼ŒAI å¹«ä½ é–‹åœ˜ï¼</p>
                            <button onClick={() => setView('create')} className="w-full bg-orange-500 text-white py-4 rounded-xl font-bold shadow-lg text-lg">
                                â• æˆ‘è¦é–‹åœ˜
                            </button>
                        </div>
                    </div>
                );
            }

            // 2. é–‹åœ˜é 
            if (view === 'create') {
                return (
                    <div className="mobile-container">
                        <div className="bg-orange-500 text-white p-4 sticky top-0 z-50 shadow-md flex items-center gap-2">
                            <button onClick={() => setView('landing')}>â¬…ï¸</button>
                            <h1 className="font-bold text-lg">å»ºç«‹æ–°åœ˜è³¼</h1>
                        </div>
                        <div className="p-6">
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                <h2 className="font-bold text-xl mb-4">ğŸ“ è²¼ä¸Šé¤å»³ç¶²å€</h2>
                                <form onSubmit={(e) => { e.preventDefault(); handleCreateGroup(e.target.url.value); }}>
                                    <input name="url" type="text" defaultValue="https://maps.app.goo.gl/example" 
                                        className="w-full p-4 border rounded-xl bg-gray-50 mb-4 focus:ring-2 focus:ring-orange-500 outline-none" placeholder="Google Maps é€£çµ..." />
                                    <button type="submit" disabled={loading} className="w-full bg-orange-500 text-white py-3 rounded-xl font-bold shadow-md">
                                        {loading ? "âŒ› AI åˆ†æä¸­..." : "ğŸ“· AI æ™ºæ…§é–‹åœ˜"}
                                    </button>
                                </form>
                                <p className="text-xs text-gray-400 mt-4 text-center">ç³»çµ±å°‡è‡ªå‹•æŠ“å– Google Maps ä¸Šçš„è³‡è¨Š</p>
                            </div>
                        </div>
                    </div>
                );
            }

            const restaurant = groupData?.restaurant || DEFAULT_RESTAURANT;
            const orders = groupData?.orders || [];
            const isClosed = groupData?.status === 'CLOSED';

            // 3. é»é¤é 
            if (view === 'order') {
                if (!groupData) return <div className="p-10 text-center">è¼‰å…¥ä¸­...</div>;
                if (isClosed) return (
                    <div className="mobile-container items-center justify-center p-8 text-center">
                        <div className="text-6xl mb-4">ğŸ”’</div>
                        <h2 className="text-xl font-bold text-gray-600">åœ˜è³¼å·²æˆªæ­¢</h2>
                        <p className="text-gray-500 mt-2">ä¸‹æ¬¡è«‹æ—©é»ä¾†ï¼</p>
                        <button onClick={() => setView('landing')} className="mt-8 text-orange-500 font-bold">å›é¦–é </button>
                    </div>
                );

                const totalQty = Object.values(cart).reduce((a, b) => a + b, 0);
                const totalPrice = Object.keys(cart).reduce((sum, id) => {
                    const item = restaurant.menu.find(m => m.id === parseInt(id));
                    return sum + (item.price * cart[id]);
                }, 0);

                return (
                    <div className="mobile-container relative">
                        {/* å§“åè¼¸å…¥å½ˆçª— */}
                        {isNameModalOpen && (
                            <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
                                <div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl">
                                    <h3 className="font-bold text-xl mb-4 text-center">è«‹å•æ‚¨æ˜¯å“ªä½ï¼Ÿ</h3>
                                    <input autoFocus type="text" placeholder="è¼¸å…¥åå­—" className="w-full p-3 border rounded-lg mb-4 text-lg text-center outline-none"
                                        onKeyDown={(e) => e.key === 'Enter' && submitName(e.target.value)} onBlur={(e) => e.target.value && setMyName(e.target.value)} />
                                    <button onClick={(e) => submitName(e.target.previousSibling.value)} className="w-full bg-orange-500 text-white py-3 rounded-xl font-bold">ç¢ºå®š</button>
                                </div>
                            </div>
                        )}

                        <div className="bg-white p-4 shadow-sm sticky top-0 z-10 flex justify-between items-start">
                            <div>
                                <h2 className="font-bold text-lg">{restaurant.name}</h2>
                                <div className="text-sm text-gray-500">ğŸ“ {restaurant.address}</div>
                            </div>
                            <button onClick={() => setIsNameModalOpen(true)} className="text-xs bg-gray-100 px-2 py-1 rounded-full text-gray-600">
                                ğŸ‘¤ {myName || "æœªç™»å…¥"}
                            </button>
                        </div>

                        <div className="p-4 space-y-3 pb-40">
                            {restaurant.menu.map(item => (
                                <div key={item.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                                    <div>
                                        <h4 className="font-bold text-gray-800">{item.name}</h4>
                                        <p className="text-orange-600 font-medium">${item.price}</p>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        {cart[item.id] > 0 && (
                                            <>
                                                <button onClick={() => removeFromCart(item.id)} className="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600">â–</button>
                                                <span className="font-bold w-4 text-center">{cart[item.id]}</span>
                                            </>
                                        )}
                                        <button onClick={() => addToCart(item.id)} className="w-8 h-8 rounded-full bg-orange-500 flex items-center justify-center text-white shadow-sm">â•</button>
                                    </div>
                                </div>
                            ))}
                        </div>

                        {totalQty > 0 && (
                            <div className="fixed bottom-0 left-0 right-0 bg-white border-t p-4 shadow-[0_-5px_20px_rgba(0,0,0,0.1)] z-20 max-w-[480px] mx-auto">
                                <div className="bg-gray-50 p-2 rounded-lg flex items-center gap-2 border border-gray-200 mb-3">
                                    <span>ğŸ’¬</span>
                                    <input type="text" value={orderNote} onChange={(e) => setOrderNote(e.target.value)} placeholder="å‚™è¨» (å¦‚: ä¸è¦é¦™èœ)" className="bg-transparent w-full text-sm outline-none" />
                                </div>
                                <div className="flex justify-between items-center">
                                    <div>
                                        <p className="text-xs text-gray-500">å·²é¸ {totalQty} æ¨£</p>
                                        <p className="text-2xl font-bold text-gray-800">${totalPrice}</p>
                                    </div>
                                    <button onClick={() => myName ? handleSubmitOrder() : setIsNameModalOpen(true)} className="bg-orange-500 text-white px-8 py-3 rounded-xl font-bold shadow-lg">é€å‡ºè¨‚å–®</button>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            // 4. ç®¡ç†å¾Œå°
            if (view === 'admin') {
                if (!groupData) return <div className="p-10 text-center">è¼‰å…¥ä¸­...</div>;
                
                const totalAmount = orders.reduce((sum, o) => sum + o.items.reduce((s, i) => s + i.price * i.qty, 0), 0);
                const isTarget = totalAmount >= restaurant.minDelivery;

                // çµ±è¨ˆæ¸…å–®
                const summary = {};
                orders.forEach(o => {
                    o.items.forEach(i => {
                        const note = o.note || "";
                        if (!summary[i.id]) summary[i.id] = { name: i.name, qty: 0, notes: {} };
                        summary[i.id].qty += i.qty;
                        if (note) summary[i.id].notes[note] = (summary[i.id].notes[note] || 0) + i.qty;
                    });
                });

                return (
                    <div className="mobile-container">
                        <div className="bg-gray-800 text-white p-4 sticky top-0 z-50 shadow-md flex justify-between items-center">
                            <button onClick={() => setView('landing')} className="text-gray-400">ğŸ </button>
                            <h1 className="font-bold text-lg">åœ˜è³¼å¾Œå°</h1>
                            <div className="w-6"></div>
                        </div>

                        <div className="p-4 space-y-4">
                            {/* ç‹€æ…‹å¡ç‰‡ */}
                            <div className={`rounded-2xl p-6 text-white shadow-lg ${isClosed ? 'bg-gray-600' : 'bg-gradient-to-r from-orange-500 to-red-500'}`}>
                                <div className="flex justify-between items-start mb-4">
                                    <div>
                                        <p className="text-white/80 text-xs mb-1">ç¸½é‡‘é¡</p>
                                        <h2 className="text-4xl font-bold flex items-center gap-1">ğŸ’² {totalAmount}</h2>
                                    </div>
                                    <div className={`px-3 py-1 rounded-full text-xs font-bold ${isTarget ? 'bg-white text-green-600' : 'bg-black/20 text-white'}`}>
                                        {isTarget ? 'å·²é”æ¨™' : `å·® $${restaurant.minDelivery - totalAmount}`}
                                    </div>
                                </div>
                                <div className="flex gap-4 border-t border-white/20 pt-4 text-sm">
                                    <span>ğŸ‘¥ {orders.length} äºº</span>
                                    <span>â° {isClosed ? 'å·²çµå–®' : 'é€²è¡Œä¸­'}</span>
                                </div>
                            </div>

                            {/* æŒ‰éˆ•å€ */}
                            <button onClick={copyLink} className="w-full bg-white border border-gray-300 py-3 rounded-xl text-gray-700 font-bold flex items-center justify-center gap-2 shadow-sm">
                                ğŸ”— è¤‡è£½åœ˜è³¼ç¶²å€ (å‚³çµ¦åŒäº‹)
                            </button>

                            {!isClosed ? (
                                <button onClick={() => { handleStatusChange('CLOSED'); copyText(`ã€åœ˜è³¼æˆªæ­¢ã€‘\nç¸½é‡‘é¡ï¼š$${totalAmount}\nè«‹æº–å‚™ä»˜æ¬¾ï¼`); }} 
                                    className="w-full bg-gray-800 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-md">
                                    ğŸ”’ çµå–®ä¸¦è¤‡è£½é€šçŸ¥
                                </button>
                            ) : (
                                <button onClick={() => copyText(`ğŸ“¢ ä¾¿ç•¶åˆ°å›‰ï¼\nç¸½é‡‘é¡ï¼š$${totalAmount}\nå¿«ä¾†é ˜å–ï¼`)} 
                                    className="w-full bg-green-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-md animate-pulse">
                                    ğŸ”” è¤‡è£½ã€Œä¾¿ç•¶åˆ°äº†ã€é€šçŸ¥
                                </button>
                            )}

                            {/* çµ±è¨ˆè¡¨ */}
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-orange-100 mt-4">
                                <div className="flex justify-between border-b pb-2 mb-2 font-bold text-gray-700">
                                    <h3>ğŸ“ å‘åº—å®¶é»é¤</h3>
                                    <a href={`tel:${restaurant.phone}`} className="text-orange-600 underline">{restaurant.phone}</a>
                                </div>
                                {Object.values(summary).map((item, idx) => (
                                    <div key={idx} className="py-2 border-b border-gray-50 last:border-0">
                                        <div className="flex justify-between font-medium">
                                            <span>{item.name}</span>
                                            <span className="text-orange-600 font-bold">x {item.qty}</span>
                                        </div>
                                        {Object.entries(item.notes).map(([note, qty], nIdx) => (
                                            <div key={nIdx} className="text-xs text-gray-500 pl-2 mt-1">â”” {note} x{qty}</div>
                                        ))}
                                    </div>
                                ))}
                            </div>

                            {/* æ˜ç´° */}
                            <div className="space-y-3 mt-4">
                                <h3 className="font-bold text-gray-700">æ˜ç´°</h3>
                                {orders.map(o => {
                                    const total = o.items.reduce((s, i) => s + i.price * i.qty, 0);
                                    return (
                                        <div key={o.id} className="bg-white p-3 rounded-xl shadow-sm flex justify-between items-center">
                                            <div>
                                                <div className="font-bold text-gray-800">{o.user} <span className="text-xs font-normal text-gray-400">{o.note}</span></div>
                                                <div className="text-xs text-gray-500">{o.items.map(i => `${i.name}x${i.qty}`).join(', ')}</div>
                                            </div>
                                            <div className="text-right font-bold text-gray-800">${total}</div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                );
            }
            return <div>Loading...</div>;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>