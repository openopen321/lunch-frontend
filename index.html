<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚ä¾¿ç•¶ç³»çµ± (æˆªåœ–ç‰ˆ)</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; }
        .mobile-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; }
        /* è²¼ä¸Šå€åŸŸçš„æ¨£å¼ */
        .paste-area {
            border: 2px dashed #f97316;
            background-color: #fff7ed;
            transition: all 0.3s;
        }
        .paste-area:hover, .paste-area.dragging {
            background-color: #ffedd5;
            border-color: #ea580c;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const DEFAULT_API_URL = "https://lunch-backend-iccv.onrender.com"; 

        function App() {
            const [view, setView] = useState('landing');
            const [loading, setLoading] = useState(false);
            const [errorMsg, setErrorMsg] = useState("");
            const [apiUrl, setApiUrl] = useState(DEFAULT_API_URL);
            const [showSettings, setShowSettings] = useState(false);
            
            const [groupId, setGroupId] = useState(null);
            const [groupData, setGroupData] = useState(null);
            const [cart, setCart] = useState({});
            const [myName, setMyName] = useState("");
            const [orderNote, setOrderNote] = useState("");
            const [isNameModalOpen, setIsNameModalOpen] = useState(false);
            
            const pasteAreaRef = useRef(null);

            useEffect(() => {
                const savedName = localStorage.getItem('userName');
                const savedUrl = localStorage.getItem('apiUrl');
                if (savedName) setMyName(savedName);
                if (savedUrl) setApiUrl(savedUrl);

                const params = new URLSearchParams(window.location.search);
                const urlGroupId = params.get('group_id');
                if (urlGroupId) {
                    setGroupId(urlGroupId);
                    fetchGroupData(urlGroupId, savedUrl || DEFAULT_API_URL);
                    setView(params.get('view') === 'admin' ? 'admin' : 'order');
                }

                // å…¨åŸŸç›£è½è²¼ä¸Šäº‹ä»¶
                const handlePaste = (e) => {
                    if (view !== 'landing') return; // åªåœ¨é¦–é ç›£è½
                    const items = e.clipboardData.items;
                    for (let i = 0; i < items.length; i++) {
                        if (items[i].type.indexOf("image") !== -1) {
                            const blob = items[i].getAsFile();
                            processImageFile(blob);
                            e.preventDefault();
                            break;
                        }
                    }
                };
                window.addEventListener('paste', handlePaste);
                return () => window.removeEventListener('paste', handlePaste);
            }, [view]); // ç•¶ view æ”¹è®Šæ™‚é‡æ–°ç¶å®š

            useEffect(() => {
                if (!groupId) return;
                const interval = setInterval(() => fetchGroupData(groupId, apiUrl), 5000);
                return () => clearInterval(interval);
            }, [groupId, apiUrl]);

            const fetchGroupData = async (id, url) => {
                try {
                    const res = await fetch(`${url}/api/group/${id}`);
                    if (res.ok) setGroupData(await res.json());
                } catch (err) { console.error(err); }
            };

            // --- åœ–ç‰‡è™•ç†æ ¸å¿ƒ ---
            const processImageFile = (file) => {
                if (!file) return;
                setLoading(true);
                setErrorMsg("");

                const reader = new FileReader();
                reader.onloadend = async () => {
                    try {
                        const base64String = reader.result.split(',')[1];
                        const mimeType = file.type;

                        // 1. å‚³çµ¦å¾Œç«¯åˆ†æ
                        const analyzeRes = await fetch(`${apiUrl}/api/analyze_menu`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ image: base64String, mime_type: mimeType })
                        });

                        if (!analyzeRes.ok) {
                            const errText = await analyzeRes.text();
                            throw new Error(`åˆ†æå¤±æ•—: ${analyzeRes.status} ${errText}`);
                        }
                        
                        const restaurantData = await analyzeRes.json();

                        if (restaurantData.name && restaurantData.name.includes("éŒ¯èª¤")) {
                            throw new Error(restaurantData.name);
                        }

                        // 2. é–‹åœ˜
                        const createRes = await fetch(`${apiUrl}/api/create_group`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ restaurant: restaurantData })
                        });

                        const { group_id } = await createRes.json();
                        setGroupId(group_id);
                        setGroupData({ restaurant: restaurantData, orders: [], status: 'OPEN' });
                        window.history.pushState({}, '', `?group_id=${group_id}&view=admin`);
                        setView('admin');

                    } catch (err) {
                        console.error(err);
                        setErrorMsg(err.message || "ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤");
                    } finally {
                        setLoading(false);
                    }
                };
                reader.readAsDataURL(file);
            };

            const handleSubmitOrder = async () => {
                if (!groupId) return;
                const newItems = [];
                Object.keys(cart).forEach(itemId => {
                    const item = groupData.restaurant.menu.find(m => m.id === parseInt(itemId));
                    if (item) newItems.push({ ...item, qty: cart[itemId] });
                });

                try {
                    await fetch(`${apiUrl}/api/group/${groupId}/order`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            id: Date.now(), user: myName, items: newItems, paidAmount: 0, status: 'unpaid', note: orderNote
                        })
                    });
                    alert(`âœ… è¨‚å–®å·²é€å‡ºï¼`);
                    setCart({}); setOrderNote(""); fetchGroupData(groupId, apiUrl);
                } catch (err) { alert("é€å‡ºå¤±æ•—"); }
            };

            // UI Components
            const addToCart = (id) => setCart(p => ({ ...p, [id]: (p[id] || 0) + 1 }));
            const removeFromCart = (id) => setCart(p => { const n = { ...p }; if (n[id] > 1) n[id]--; else delete n[id]; return n; });
            
            // --- Views ---
            if (showSettings) return (
                <div className="mobile-container p-6">
                    <h2 className="text-xl font-bold mb-4">âš™ï¸ è¨­å®š</h2>
                    <input type="text" value={apiUrl} onChange={(e) => setApiUrl(e.target.value)} className="w-full p-3 border rounded mb-4" />
                    <button onClick={() => { localStorage.setItem('apiUrl', apiUrl.replace(/\/$/, "")); setShowSettings(false); }} className="w-full bg-green-500 text-white py-2 rounded">å„²å­˜</button>
                </div>
            );

            if (view === 'landing') return (
                <div className="mobile-container">
                    <div className="bg-orange-500 text-white p-4 flex justify-between items-center shadow-md">
                        <h1 className="font-bold text-lg">ğŸ± æˆªåœ–é–‹åœ˜</h1>
                        <button onClick={() => setShowSettings(true)} className="text-white"><i className="fa-solid fa-gear"></i></button>
                    </div>
                    <div className="p-6 flex flex-col items-center justify-center flex-1">
                        {/* è²¼ä¸Šå€åŸŸ */}
                        <div 
                            ref={pasteAreaRef}
                            className="paste-area w-full h-64 rounded-2xl flex flex-col items-center justify-center text-center cursor-pointer mb-6 p-4"
                            onClick={async () => {
                                try {
                                    const clipboardItems = await navigator.clipboard.read();
                                    for (const clipboardItem of clipboardItems) {
                                        for (const type of clipboardItem.types) {
                                            if (type.startsWith('image/')) {
                                                const blob = await clipboardItem.getType(type);
                                                processImageFile(blob);
                                                return;
                                            }
                                        }
                                    }
                                    alert("å‰ªè²¼ç°¿è£¡æ²’æœ‰åœ–ç‰‡å–”ï¼è«‹å…ˆæˆªåœ–æˆ–è¤‡è£½åœ–ç‰‡ã€‚");
                                } catch (err) {
                                    // å¦‚æœç€è¦½å™¨ä¸æ”¯æ´ç›´æ¥è®€å–å‰ªè²¼ç°¿ APIï¼Œæç¤ºç”¨ Ctrl+V
                                    alert("è«‹ç›´æ¥æŒ‰ Ctrl+V (æˆ– Command+V) è²¼ä¸Šåœ–ç‰‡ï¼");
                                }
                            }}
                        >
                            {loading ? (
                                <div className="flex flex-col items-center text-orange-500">
                                    <i className="fa-solid fa-circle-notch fa-spin text-4xl mb-2"></i>
                                    <span className="font-bold">AI æ­£åœ¨è®€å–èœå–®ä¸­...</span>
                                </div>
                            ) : (
                                <>
                                    <i className="fa-solid fa-paste text-4xl text-orange-400 mb-2"></i>
                                    <h3 className="text-xl font-bold text-gray-700 mb-1">é»æ“Šè²¼ä¸Šæˆªåœ–</h3>
                                    <p className="text-sm text-gray-500">æˆ–ç›´æ¥æŒ‰ Ctrl + V</p>
                                </>
                            )}
                        </div>

                        {errorMsg && <div className="text-red-500 text-xs text-center px-4 mb-4 bg-red-50 p-2 rounded w-full">{errorMsg}</div>}
                        
                        <div className="text-xs text-gray-400 text-center">
                            æ”¯æ´é›»è…¦æˆªåœ–ã€æ‰‹æ©Ÿæˆªåœ–<br/>
                            è‡ªå‹•åˆ‡æ› Gemini Pro / Flash æ¨¡å‹
                        </div>
                    </div>
                </div>
            );

            if (!groupData) return <div className="mobile-container items-center justify-center"><i className="fa-solid fa-spinner fa-spin text-3xl text-orange-500"></i></div>;

            const { restaurant, orders, status } = groupData;
            const totalAmount = orders.reduce((sum, o) => sum + o.items.reduce((s, i) => s + i.price * i.qty, 0), 0);

            if (view === 'order') return (
                <div className="mobile-container relative">
                    {isNameModalOpen && (
                        <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
                            <div className="bg-white p-6 rounded-2xl w-full max-w-sm">
                                <h3 className="font-bold text-xl mb-4 text-center">è«‹å•æ‚¨æ˜¯å“ªä½ï¼Ÿ</h3>
                                <input autoFocus type="text" className="w-full p-3 border rounded-lg mb-4 text-center" onBlur={(e) => e.target.value && setMyName(e.target.value)} />
                                <button onClick={(e) => { if(e.target.previousSibling.value) { setMyName(e.target.previousSibling.value); localStorage.setItem('userName', e.target.previousSibling.value); setIsNameModalOpen(false); handleSubmitOrder(); }}} className="w-full bg-orange-500 text-white py-3 rounded-xl font-bold">ç¢ºå®š</button>
                            </div>
                        </div>
                    )}
                    <div className="bg-white p-4 shadow-sm sticky top-0 z-10 flex justify-between">
                        <h2 className="font-bold text-lg">{restaurant.name}</h2>
                        <button onClick={() => setIsNameModalOpen(true)} className="text-xs bg-gray-100 px-2 py-1 rounded-full text-gray-600"><i className="fa-solid fa-user"></i> {myName || "ç™»å…¥"}</button>
                    </div>
                    <div className="p-4 space-y-3 pb-40">
                        {restaurant.menu.map(item => (
                            <div key={item.id} className="bg-white p-4 rounded-xl shadow-sm border flex justify-between items-center">
                                <div><h4 className="font-bold">{item.name}</h4><p className="text-orange-600 font-medium">${item.price}</p></div>
                                <div className="flex items-center gap-3">
                                    {cart[item.id] > 0 && <button onClick={() => removeFromCart(item.id)} className="w-8 h-8 bg-gray-200 rounded-full text-gray-600">-</button>}
                                    {cart[item.id] > 0 && <span className="font-bold w-4 text-center">{cart[item.id]}</span>}
                                    <button onClick={() => addToCart(item.id)} className="w-8 h-8 bg-orange-500 rounded-full text-white">+</button>
                                </div>
                            </div>
                        ))}
                    </div>
                    {Object.keys(cart).length > 0 && (
                        <div className="fixed bottom-0 left-0 right-0 bg-white border-t p-4 z-20 max-w-[480px] mx-auto flex justify-between items-center">
                            <p className="text-xl font-bold">${Object.keys(cart).reduce((s, id) => s + restaurant.menu.find(m => m.id == id).price * cart[id], 0)}</p>
                            <button onClick={() => myName ? handleSubmitOrder() : setIsNameModalOpen(true)} className="bg-orange-500 text-white px-8 py-3 rounded-xl font-bold shadow-lg">é€å‡º</button>
                        </div>
                    )}
                </div>
            );

            if (view === 'admin') return (
                <div className="mobile-container">
                    <div className="bg-gray-800 text-white p-4 flex justify-between items-center shadow-md">
                        <button onClick={() => setView('landing')}><i className="fa-solid fa-house"></i></button>
                        <h1 className="font-bold text-lg">å¾Œå°ç®¡ç†</h1><div className="w-6"></div>
                    </div>
                    <div className="p-4 space-y-4">
                        <div className="rounded-2xl p-6 bg-gradient-to-r from-orange-500 to-red-500 text-white shadow-lg">
                            <p className="text-xs opacity-80">ç¸½é‡‘é¡</p><h2 className="text-4xl font-bold">${totalAmount}</h2>
                            <div className="mt-4 text-sm flex gap-4"><span><i className="fa-solid fa-users"></i> {orders.length}äºº</span><span><i className="fa-solid fa-circle-check"></i> {status === 'CLOSED' ? 'å·²çµå–®' : 'é€²è¡Œä¸­'}</span></div>
                        </div>
                        <button onClick={() => navigator.clipboard.writeText(window.location.href.replace('view=admin', 'view=order')).then(() => alert("ç¶²å€å·²è¤‡è£½"))} className="w-full bg-white border py-3 rounded-xl font-bold shadow-sm">ğŸ”— è¤‡è£½åˆ†äº«ç¶²å€</button>
                        
                        <div className="space-y-2">
                            {orders.map(o => (
                                <div key={o.id} className="bg-white p-3 rounded-xl shadow-sm flex justify-between">
                                    <div><div className="font-bold">{o.user}</div><div className="text-xs text-gray-500">{o.items.map(i => `${i.name} x${i.qty}`).join(', ')}</div></div>
                                    <div className="font-bold">${o.items.reduce((s,i)=>s+i.price*i.qty,0)}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
            return <div></div>;
        }
        const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<App />);
    </script>
</body>
</html>