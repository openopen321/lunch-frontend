<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¾¦å…¬å®¤è¨‚ä¾¿ç•¶ç³»çµ± (é™¤éŒ¯ç‰ˆ)</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; }
        .mobile-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // é è¨­å¾Œç«¯ç¶²å€ (è«‹ç¢ºèªé€™è·Ÿä½ çš„ Render ç¶²å€ä¸€æ¨¡ä¸€æ¨£)
        const DEFAULT_API_URL = "https://lunch-backend-iccv.onrender.com";

        function App() {
            const [view, setView] = useState('landing');
            const [loading, setLoading] = useState(false);
            const [errorMsg, setErrorMsg] = useState(""); // ç”¨ä¾†é¡¯ç¤ºéŒ¯èª¤
            
            // è¨­å®šç›¸é—œ
            const [apiUrl, setApiUrl] = useState(DEFAULT_API_URL);
            const [showSettings, setShowSettings] = useState(false);

            const [groupId, setGroupId] = useState(null);
            const [groupData, setGroupData] = useState(null);
            const [cart, setCart] = useState({});
            const [myName, setMyName] = useState("");
            const [orderNote, setOrderNote] = useState("");
            const [isNameModalOpen, setIsNameModalOpen] = useState(false);

            // åˆå§‹åŒ–
            useEffect(() => {
                const savedName = localStorage.getItem('userName');
                const savedUrl = localStorage.getItem('apiUrl');
                
                if (savedName) setMyName(savedName);
                if (savedUrl) setApiUrl(savedUrl);

                const params = new URLSearchParams(window.location.search);
                const urlGroupId = params.get('group_id');
                const urlView = params.get('view');

                if (urlGroupId) {
                    setGroupId(urlGroupId);
                    fetchGroupData(urlGroupId, savedUrl || DEFAULT_API_URL);
                    if (urlView === 'order') setView('order');
                    else if (urlView === 'admin') setView('admin');
                    else setView('order');
                }
            }, []);

            // å®šæ™‚æ›´æ–°
            useEffect(() => {
                if (!groupId) return;
                const interval = setInterval(() => {
                    fetchGroupData(groupId, apiUrl);
                }, 5000);
                return () => clearInterval(interval);
            }, [groupId, apiUrl]);

            // --- API ---

            const fetchGroupData = async (id, url) => {
                try {
                    const res = await fetch(`${url}/api/group/${id}`);
                    if (res.ok) {
                        const data = await res.json();
                        setGroupData(data);
                        setErrorMsg("");
                    } else {
                        console.log("åŒæ­¥å¤±æ•—ï¼Œå¯èƒ½ç¶²è·¯ä¸ç©©");
                    }
                } catch (err) {
                    // èƒŒæ™¯æ›´æ–°å¤±æ•—ä¸éœ€ä¸€ç›´è·³éŒ¯èª¤
                    console.error(err);
                }
            };

            const handleSaveSettings = () => {
                // ç§»é™¤çµå°¾æ–œç·š
                let cleanUrl = apiUrl.replace(/\/$/, "");
                setApiUrl(cleanUrl);
                localStorage.setItem('apiUrl', cleanUrl);
                setShowSettings(false);
                alert("ç¶²å€å·²æ›´æ–°ï¼");
            };

            const testConnection = async () => {
                setLoading(true);
                setErrorMsg("");
                try {
                    const res = await fetch(apiUrl);
                    const text = await res.text();
                    if (res.ok) alert("âœ… é€£ç·šæˆåŠŸï¼\nå¾Œç«¯å›æ‡‰: " + text);
                    else alert("âŒ é€£ç·šå¤±æ•—: " + res.status);
                } catch (err) {
                    alert("âŒ ç„¡æ³•é€£ç·šåˆ°å¾Œç«¯ï¼\nè«‹æª¢æŸ¥ç¶²å€æ˜¯å¦æ­£ç¢ºï¼Œæˆ– Render æ˜¯å¦æ­£åœ¨å–šé†’ä¸­(éœ€ç­‰1åˆ†é˜)ã€‚\néŒ¯èª¤: " + err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleCreateGroup = async (url) => {
                setLoading(true);
                setErrorMsg("");
                try {
                    // 1. åˆ†æ
                    const analyzeRes = await fetch(`${apiUrl}/api/analyze_menu`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ url })
                    });
                    
                    if (!analyzeRes.ok) throw new Error(`åˆ†æå¤±æ•— (${analyzeRes.status})`);
                    const restaurantData = await analyzeRes.json();

                    // 2. é–‹åœ˜
                    const createRes = await fetch(`${apiUrl}/api/create_group`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ restaurant: restaurantData })
                    });
                    
                    if (!createRes.ok) throw new Error("å»ºç«‹åœ˜è³¼å¤±æ•—");
                    const { group_id } = await createRes.json();

                    setGroupId(group_id);
                    setGroupData({ restaurant: restaurantData, orders: [], status: 'OPEN' });
                    window.history.pushState({}, '', `?group_id=${group_id}&view=admin`);
                    setView('admin');
                } catch (err) {
                    setErrorMsg(err.message + "\n(è‹¥ Render ä¼‘çœ ä¸­ï¼Œè«‹ç¨ç­‰1åˆ†é˜å†è©¦ä¸€æ¬¡)");
                } finally {
                    setLoading(false);
                }
            };

            const handleSubmitOrder = async () => {
                if (!groupId) return;
                const newItems = [];
                Object.keys(cart).forEach(itemId => {
                    const item = groupData.restaurant.menu.find(m => m.id === parseInt(itemId));
                    if (item) newItems.push({ ...item, qty: cart[itemId] });
                });

                try {
                    const res = await fetch(`${apiUrl}/api/group/${groupId}/order`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            id: Date.now(),
                            user: myName,
                            items: newItems,
                            paidAmount: 0,
                            status: 'unpaid',
                            note: orderNote
                        })
                    });
                    if(!res.ok) throw new Error("é€å‡ºå¤±æ•—");
                    
                    alert(`âœ… è¨‚å–®å·²é€å‡ºï¼\nè¨‚è³¼äººï¼š${myName}`);
                    setCart({});
                    setOrderNote("");
                    fetchGroupData(groupId, apiUrl);
                } catch (err) {
                    alert("âŒ é€å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦");
                }
            };

            const handleStatusChange = async (newStatus) => {
                try {
                    await fetch(`${apiUrl}/api/group/${groupId}/status`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ status: newStatus })
                    });
                    setGroupData(prev => ({ ...prev, status: newStatus }));
                } catch (err) {
                    alert("æ›´æ–°ç‹€æ…‹å¤±æ•—");
                }
            };

            // --- UI Components ---

            const copyLink = () => {
                const url = `${window.location.origin}${window.location.pathname}?group_id=${groupId}&view=order`;
                navigator.clipboard.writeText(url).then(() => alert("âœ… ç¶²å€å·²è¤‡è£½ï¼"));
            };

            const copyText = (text) => {
                navigator.clipboard.writeText(text).then(() => alert("âœ… æ–‡å­—å·²è¤‡è£½ï¼"));
            };

            // è³¼ç‰©è»Šé‚è¼¯
            const addToCart = (id) => setCart(prev => ({ ...prev, [id]: (prev[id] || 0) + 1 }));
            const removeFromCart = (id) => setCart(prev => {
                const n = { ...prev };
                if (n[id] > 1) n[id]--; else delete n[id];
                return n;
            });
            const totalQty = Object.values(cart).reduce((a, b) => a + b, 0);
            const totalPrice = groupData ? Object.keys(cart).reduce((sum, id) => {
                const item = groupData.restaurant.menu.find(m => m.id === parseInt(id));
                return sum + (item ? item.price * cart[id] : 0);
            }, 0) : 0;

            // --- Pages ---

            if (showSettings) {
                return (
                    <div className="mobile-container p-6">
                        <h2 className="text-xl font-bold mb-4">âš™ï¸ è¨­å®šå¾Œç«¯ç¶²å€</h2>
                        <p className="text-sm text-gray-500 mb-2">å¦‚æœé–‹åœ˜ä¸€ç›´å¤±æ•—ï¼Œè«‹æª¢æŸ¥é€™è£¡çš„ç¶²å€æ˜¯å¦æ­£ç¢ºã€‚</p>
                        <input 
                            type="text" 
                            value={apiUrl} 
                            onChange={(e) => setApiUrl(e.target.value)}
                            className="w-full p-3 border rounded mb-4 text-sm"
                        />
                        <div className="flex gap-2">
                            <button onClick={testConnection} className="flex-1 bg-blue-500 text-white py-2 rounded">æ¸¬è©¦é€£ç·š</button>
                            <button onClick={handleSaveSettings} className="flex-1 bg-green-500 text-white py-2 rounded">å„²å­˜ä¸¦è¿”å›</button>
                        </div>
                        <button onClick={() => setShowSettings(false)} className="mt-4 text-gray-500 underline w-full">å–æ¶ˆ</button>
                        
                        <div className="mt-8 p-4 bg-gray-100 rounded text-xs text-gray-600 break-all">
                            <p className="font-bold">ç›®å‰çš„å¾Œç«¯ç¶²å€ï¼š</p>
                            {apiUrl}
                        </div>
                    </div>
                );
            }

            if (view === 'landing') {
                return (
                    <div className="mobile-container">
                        <div className="bg-orange-500 text-white p-4 flex justify-between items-center shadow-md">
                            <h1 className="font-bold text-lg">ğŸ± è¨‚ä¾¿ç•¶ç³»çµ±</h1>
                            <button onClick={() => setShowSettings(true)} className="text-white opacity-80"><i className="fa-solid fa-gear"></i></button>
                        </div>
                        <div className="p-6 flex flex-col items-center justify-center flex-1 animate-fade-in">
                            <div className="text-6xl mb-4">ğŸ±</div>
                            <h2 className="text-2xl font-bold text-gray-800 mb-2">ä»Šå¤©åƒä»€éº¼ï¼Ÿ</h2>
                            <p className="text-gray-500 text-center mb-8">è²¼ä¸Š Google Mapsï¼ŒAI å¹«ä½ é–‹åœ˜ï¼</p>
                            
                            <button onClick={() => setView('create')} className="w-full bg-orange-500 text-white py-4 rounded-xl font-bold shadow-lg text-lg mb-4 active:scale-95 transition-transform">
                                â• æˆ‘è¦é–‹åœ˜
                            </button>
                        </div>
                    </div>
                );
            }

            if (view === 'create') {
                return (
                    <div className="mobile-container">
                        <div className="bg-orange-500 text-white p-4 flex items-center gap-2 shadow-md">
                            <button onClick={() => setView('landing')}><i className="fa-solid fa-arrow-left"></i></button>
                            <h1 className="font-bold text-lg">å»ºç«‹æ–°åœ˜è³¼</h1>
                        </div>
                        <div className="p-6">
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                <h2 className="font-bold text-xl mb-4 text-gray-800">ğŸ“ è²¼ä¸Šé¤å»³ç¶²å€</h2>
                                <form onSubmit={(e) => { e.preventDefault(); handleCreateGroup(e.target.url.value); }}>
                                    <input name="url" type="text" defaultValue="https://maps.app.goo.gl/example" 
                                        className="w-full p-4 border rounded-xl bg-gray-50 mb-4 focus:ring-2 focus:ring-orange-500 outline-none" placeholder="Google Maps é€£çµ..." />
                                    
                                    {errorMsg && (
                                        <div className="mb-4 p-3 bg-red-50 text-red-600 text-xs rounded border border-red-100">
                                            âŒ {errorMsg}
                                        </div>
                                    )}

                                    <button type="submit" disabled={loading} className="w-full bg-orange-500 text-white py-3 rounded-xl font-bold shadow-md disabled:bg-gray-400 flex justify-center items-center gap-2">
                                        {loading ? <span><i className="fa-solid fa-circle-notch fa-spin"></i> AI åˆ†æä¸­ (ç´„éœ€10-20ç§’)...</span> : <span>ğŸ“· AI æ™ºæ…§é–‹åœ˜</span>}
                                    </button>
                                </form>
                                <p className="text-xs text-gray-400 mt-4 text-center">è‹¥ Render ä¼‘çœ ä¸­ï¼Œé¦–æ¬¡å•Ÿå‹•å¯èƒ½éœ€è¦ 1-2 åˆ†é˜</p>
                            </div>
                        </div>
                    </div>
                );
            }

            // è¼‰å…¥ä¸­
            if (!groupData) return (
                <div className="mobile-container items-center justify-center">
                    <i className="fa-solid fa-spinner fa-spin text-4xl text-orange-500"></i>
                    <p className="mt-2 text-gray-500">è¼‰å…¥è¨‚å–®è³‡æ–™ä¸­...</p>
                </div>
            );

            const { restaurant, orders, status } = groupData;
            const isClosed = status === 'CLOSED';

            if (view === 'order') {
                if (isClosed) return (
                    <div className="mobile-container items-center justify-center p-8 text-center">
                        <div className="text-6xl mb-4">ğŸ”’</div>
                        <h2 className="text-xl font-bold text-gray-600">åœ˜è³¼å·²æˆªæ­¢</h2>
                        <button onClick={() => setView('landing')} className="mt-8 text-orange-500 font-bold">å›é¦–é </button>
                    </div>
                );

                return (
                    <div className="mobile-container relative">
                        {isNameModalOpen && (
                            <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
                                <div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl animate-fade-in">
                                    <h3 className="font-bold text-xl mb-4 text-center">è«‹å•æ‚¨æ˜¯å“ªä½ï¼Ÿ</h3>
                                    <input autoFocus type="text" placeholder="è¼¸å…¥åå­—" className="w-full p-3 border rounded-lg mb-4 text-lg text-center outline-none"
                                        onBlur={(e) => e.target.value && setMyName(e.target.value)} />
                                    <button onClick={(e) => {
                                        const val = e.target.previousSibling.value;
                                        if(val) { setMyName(val); localStorage.setItem('userName', val); setIsNameModalOpen(false); handleSubmitOrder(); }
                                    }} className="w-full bg-orange-500 text-white py-3 rounded-xl font-bold">ç¢ºå®š</button>
                                </div>
                            </div>
                        )}

                        <div className="bg-white p-4 shadow-sm sticky top-0 z-10 flex justify-between items-start">
                            <div>
                                <h2 className="font-bold text-lg">{restaurant.name}</h2>
                                <div className="text-sm text-gray-500">ğŸ“ {restaurant.address || "åœ°å€æœªçŸ¥"}</div>
                            </div>
                            <button onClick={() => setIsNameModalOpen(true)} className="text-xs bg-gray-100 px-2 py-1 rounded-full text-gray-600">
                                <i className="fa-solid fa-user"></i> {myName || "æœªç™»å…¥"}
                            </button>
                        </div>

                        <div className="p-4 space-y-3 pb-40">
                            {restaurant.menu.map(item => (
                                <div key={item.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                                    <div>
                                        <h4 className="font-bold text-gray-800">{item.name}</h4>
                                        <p className="text-orange-600 font-medium">${item.price}</p>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        {cart[item.id] > 0 && (
                                            <>
                                                <button onClick={() => removeFromCart(item.id)} className="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600"><i className="fa-solid fa-minus"></i></button>
                                                <span className="font-bold w-4 text-center">{cart[item.id]}</span>
                                            </>
                                        )}
                                        <button onClick={() => addToCart(item.id)} className="w-8 h-8 rounded-full bg-orange-500 flex items-center justify-center text-white shadow-sm"><i className="fa-solid fa-plus"></i></button>
                                    </div>
                                </div>
                            ))}
                        </div>

                        {totalQty > 0 && (
                            <div className="fixed bottom-0 left-0 right-0 bg-white border-t p-4 shadow-[0_-5px_20px_rgba(0,0,0,0.1)] z-20 max-w-[480px] mx-auto">
                                <div className="bg-gray-50 p-2 rounded-lg flex items-center gap-2 border border-gray-200 mb-3">
                                    <i className="fa-regular fa-comment-dots text-gray-400"></i>
                                    <input type="text" value={orderNote} onChange={(e) => setOrderNote(e.target.value)} placeholder="å‚™è¨» (å¦‚: ä¸è¦é¦™èœ)" className="bg-transparent w-full text-sm outline-none" />
                                </div>
                                <div className="flex justify-between items-center">
                                    <div>
                                        <p className="text-xs text-gray-500">å·²é¸ {totalQty} æ¨£</p>
                                        <p className="text-2xl font-bold text-gray-800">${totalPrice}</p>
                                    </div>
                                    <button onClick={() => myName ? handleSubmitOrder() : setIsNameModalOpen(true)} className="bg-orange-500 text-white px-8 py-3 rounded-xl font-bold shadow-lg">é€å‡ºè¨‚å–®</button>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            if (view === 'admin') {
                const totalAmount = orders.reduce((sum, o) => sum + o.items.reduce((s, i) => s + i.price * i.qty, 0), 0);
                const isTarget = totalAmount >= restaurant.minDelivery;
                
                const summary = {};
                orders.forEach(o => {
                    o.items.forEach(i => {
                        if (!summary[i.id]) summary[i.id] = { name: i.name, qty: 0, notes: {} };
                        summary[i.id].qty += i.qty;
                        if (o.note) summary[i.id].notes[o.note] = (summary[i.id].notes[o.note] || 0) + i.qty;
                    });
                });

                return (
                    <div className="mobile-container">
                        <div className="bg-gray-800 text-white p-4 sticky top-0 z-50 shadow-md flex justify-between items-center">
                            <button onClick={() => setView('landing')} className="text-gray-400"><i className="fa-solid fa-house"></i></button>
                            <h1 className="font-bold text-lg">åœ˜è³¼å¾Œå°</h1>
                            <div className="w-6"></div>
                        </div>

                        <div className="p-4 space-y-4">
                            <div className={`rounded-2xl p-6 text-white shadow-lg ${isClosed ? 'bg-gray-600' : 'bg-gradient-to-r from-orange-500 to-red-500'}`}>
                                <div className="flex justify-between items-start mb-4">
                                    <div>
                                        <p className="text-white/80 text-xs mb-1">ç¸½é‡‘é¡</p>
                                        <h2 className="text-4xl font-bold flex items-center gap-1">ğŸ’² {totalAmount}</h2>
                                    </div>
                                    <div className={`px-3 py-1 rounded-full text-xs font-bold ${isTarget ? 'bg-white text-green-600' : 'bg-black/20 text-white'}`}>
                                        {isTarget ? 'å·²é”æ¨™' : `å·® $${restaurant.minDelivery - totalAmount}`}
                                    </div>
                                </div>
                                <div className="flex gap-4 border-t border-white/20 pt-4 text-sm">
                                    <span><i className="fa-solid fa-user-group"></i> {orders.length} äºº</span>
                                    <span><i className="fa-solid fa-clock"></i> {isClosed ? 'å·²çµå–®' : 'é€²è¡Œä¸­'}</span>
                                </div>
                            </div>

                            <button onClick={copyLink} className="w-full bg-white border border-gray-300 py-3 rounded-xl text-gray-700 font-bold flex items-center justify-center gap-2 shadow-sm">
                                <i className="fa-solid fa-link"></i> è¤‡è£½åœ˜è³¼ç¶²å€
                            </button>

                            {!isClosed ? (
                                <button onClick={() => { handleStatusChange('CLOSED'); copyText(`ã€åœ˜è³¼æˆªæ­¢ã€‘\nç¸½é‡‘é¡ï¼š$${totalAmount}\nè«‹æº–å‚™ä»˜æ¬¾ï¼`); }} 
                                    className="w-full bg-gray-800 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-md">
                                    <i className="fa-solid fa-lock"></i> çµå–®ä¸¦è¤‡è£½é€šçŸ¥
                                </button>
                            ) : (
                                <button onClick={() => copyText(`ğŸ“¢ ä¾¿ç•¶åˆ°å›‰ï¼\nç¸½é‡‘é¡ï¼š$${totalAmount}\nå¿«ä¾†é ˜å–ï¼`)} 
                                    className="w-full bg-green-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-md animate-pulse">
                                    <i className="fa-solid fa-bell"></i> è¤‡è£½ã€Œä¾¿ç•¶åˆ°äº†ã€é€šçŸ¥
                                </button>
                            )}

                            <div className="bg-white p-4 rounded-xl shadow-sm border border-orange-100 mt-4">
                                <div className="flex justify-between border-b pb-2 mb-2 font-bold text-gray-700">
                                    <h3><i className="fa-solid fa-phone"></i> å‘åº—å®¶é»é¤</h3>
                                    <a href={`tel:${restaurant.phone}`} className="text-orange-600 underline">{restaurant.phone}</a>
                                </div>
                                {Object.values(summary).map((item, idx) => (
                                    <div key={idx} className="py-2 border-b border-gray-50 last:border-0">
                                        <div className="flex justify-between font-medium">
                                            <span>{item.name}</span>
                                            <span className="text-orange-600 font-bold">x {item.qty}</span>
                                        </div>
                                        {Object.entries(item.notes).map(([note, qty], nIdx) => (
                                            <div key={nIdx} className="text-xs text-gray-500 pl-2 mt-1">â”” {note} x{qty}</div>
                                        ))}
                                    </div>
                                ))}
                            </div>

                            <div className="space-y-3 mt-4">
                                <h3 className="font-bold text-gray-700">æ˜ç´°</h3>
                                {orders.map(o => {
                                    const total = o.items.reduce((s, i) => s + i.price * i.qty, 0);
                                    return (
                                        <div key={o.id} className="bg-white p-3 rounded-xl shadow-sm flex justify-between items-center">
                                            <div>
                                                <div className="font-bold text-gray-800">{o.user} <span className="text-xs font-normal text-gray-400">{o.note}</span></div>
                                                <div className="text-xs text-gray-500">{o.items.map(i => `${i.name}x${i.qty}`).join(', ')}</div>
                                            </div>
                                            <div className="text-right font-bold text-gray-800">${total}</div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                );
            }
            return <div></div>;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>